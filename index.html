<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tap Sprint — Telegram WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f0f13;
      --text: #ffffff;
      --accent: #3b82f6;
      --accent-2: #22c55e;
      --muted: #9aa0a6;
      --card: #16161c;
    }
    html, body {height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui;}
    #app {max-width:480px;margin:0 auto;padding:16px;}
    header {display:flex;align-items:baseline;justify-content:space-between;}
    h1 {font-size:20px;margin:8px 0;}
    .stats {color:var(--muted);font-weight:600;}
    main {margin-top:20px;background:var(--card);border-radius:12px;padding:20px;}
    #tap {width:100%;height:180px;border:none;border-radius:12px;
          background:linear-gradient(180deg,var(--accent),#1d4ed8);
          color:#fff;font-size:28px;font-weight:800;cursor:pointer;}
    #tap:active {transform:scale(0.98);filter:brightness(1.1);}
    #combo {margin:14px 6px;color:var(--accent-2);font-weight:700;}
    #progress {width:100%;height:10px;background:#222631;border-radius:999px;overflow:hidden;}
    #bar {width:100%;height:100%;background:var(--accent-2);transform-origin:left center;transform:scaleX(1);}
    footer {display:flex;justify-content:center;margin-top:16px;}
    #restart {background:#2a2f3a;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer;}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Tap Sprint</h1>
      <div class="stats"><span id="time">30</span>s · очки: <span id="score">0</span></div>
    </header>
    <main>
      <button id="tap">Жми!</button>
      <div id="combo">Комбо ×1</div>
      <div id="progress"><div id="bar"></div></div>
    </main>
    <footer><button id="restart">Заново</button></footer>
  </div>

  <script>
    const DURATION = 30;
    let timeLeft = DURATION, score = 0, combo = 1, comboTimer, ticking, finished = false;
    const tg = window.Telegram?.WebApp;
    const els = {
      time: document.getElementById('time'),
      score: document.getElementById('score'),
      tap: document.getElementById('tap'),
      combo: document.getElementById('combo'),
      bar: document.getElementById('bar'),
      restart: document.getElementById('restart')
    };

    function applyTheme() {
      if (!tg) return;
      tg.ready(); tg.expand();
      const theme = tg.themeParams || {};
      const root = document.documentElement;
      if (theme.bg_color) root.style.setProperty('--bg', theme.bg_color);
      if (theme.text_color) root.style.setProperty('--text', theme.text_color);
      if (theme.button_color) root.style.setProperty('--accent', theme.button_color);
      if (theme.secondary_bg_color) root.style.setProperty('--card', theme.secondary_bg_color);
      tg.MainButton.setText('Отправить результат'); tg.MainButton.hide();
      tg.onEvent('mainButtonClicked', submitResult);
    }
    applyTheme();

    function haptic(type='light'){if(!tg?.HapticFeedback)return;try{tg.HapticFeedback.impactOccurred(type);}catch{}}
    function updateUI(){els.time.textContent=timeLeft;els.score.textContent=score;
      els.bar.style.transform=`scaleX(${Math.max(0,timeLeft/DURATION)})`;
      els.combo.textContent=`Комбо ×${combo}`;}
    function startTimer(){clearInterval(ticking);ticking=setInterval(()=>{timeLeft--;updateUI();if(timeLeft<=0)finish();},1000);}
    function tap(){if(finished||timeLeft<=0)return;score+=combo;haptic('light');combo=Math.min(combo+1,10);updateUI();
      clearTimeout(comboTimer);comboTimer=setTimeout(()=>{combo=Math.max(1,Math.floor(combo*0.5));updateUI();},800);}
    function finish(){if(finished)return;finished=true;clearInterval(ticking);clearTimeout(comboTimer);updateUI();haptic('success');
      if(tg){tg.MainButton.show();tg.showPopup({title:'Игра окончена',message:`Твои очки: ${score}`,buttons:[{type:'close'}]});}
      else alert(`Игра окончена! Очки: ${score}`);}
    function reset(){timeLeft=DURATION;score=0;combo=1;finished=false;updateUI();startTimer();if(tg)tg.MainButton.hide();}
    function submitResult(){const payload={score,time:DURATION};tg?.sendData?.(JSON.stringify(payload));tg?.close?.();}
    els.tap.addEventListener('click',tap);els.restart.addEventListener('click',reset);reset();
  </script>
</body>
</html>
